--´´½¨ÈË[ QUFEI 2007-11-29 10:10 UPDATE BugID 27819 ]
--Ç§Ñ°ÈÎÎñÊÂ¼ş½Å±¾
--Ã¿ÖÖ¹ØÏµÈÎÎñÃ¿ÌìÖ»ÄÜ×ömµt ´Î,Ã¿´Î20»·

--MisDescBegin
--½Å±¾ºÅ
x229024_g_ScriptId	= 229024

--Tiªp thøÈÎÎñNPCÊôĞÔ
x229024_g_Position_X=129.2676
x229024_g_Position_Z=213.0914
x229024_g_SceneID=1
x229024_g_AccomplishNPC_Name="Tä Ğ°ng"

--ÈÎÎñºÅ
x229024_g_MissionId			= 421
--ÏÂmµt cáiÈÎÎñtoÕ ğµ ID
x229024_g_MissionIdNext	= 421
--Møc tiêu nhi®m vønpc
x229024_g_Name			= "Tä Ğ°ng"
--ÈÎÎñ¹éÀà
x229024_g_MissionKind			= 12
--ĞÆng c¤p nhi®m vø
x229024_g_MissionLevel		= 10
--Ğúng·ñĞúngTinhÓ¢ÈÎÎñ
x229024_g_IfMissionElite	= 0
--ÈÎÎñĞúng·ñÒÑ¾­Íê³É
x229024_g_IsMissionOkFail	= 0		--±äÁ¿toÕ ğµ µÚ0Î»

--ÈÎÎñÎÄ±¾ÃèÊö
x229024_g_MissionName			= "Thiên T¥m"
--ÈÎÎñÃèÊö
x229024_g_MissionInfo			= "#{QX_20071129_026}"
--Møc tiêu nhi®m vø
x229024_g_MissionTarget		= "#{QX_20071129_025}"
--Î´Hoàn t¤t nhi®m vøtoÕ ğµ npc¶Ô»°
x229024_g_ContinueInfo		= "#{QIANXUN_INFO_19}"
--Hoàn t¤t nhi®m vønpcËµtoÕ ğµ »°
x229024_g_MissionComplete	= "#{QX_20071129_039}"
--Ã¿ÌìÃ¿ÖÖ¹ØÏµtoÕ ğµ »·ÊıÉÏÏŞ
x229024_g_MaxRound	= 10
--¿ØÖÆ½Å±¾
x229024_g_ControlScript		= 001066
--MisDescEnd

--ÈÎÎñĞúng·ñÍê³É
x229024_g_Mission_IsComplete = 0		--µÚ0Î»²ÎÊı
--ÈÎÎñ»·Êı
x229024_g_Mission_RoundNum	 = 5		--µÚ5Î»²ÎÊı
--ÈÎÎñÎïÆ·ĞòºÅ
x229024_g_Mission_ItemIdx		 = 6		--µÚ6Î»²ÎÊı

x229024_g_QianXunMission_IDX	= 120	--Ç§Ñ°ÈÎÎñË÷Òı
x229024_g_MissionInfo_IDX			= 121	--ÈÎÎñË ği¬m÷Ë÷Òı
x229024_g_FuQiMission_IDX		 	= 131	--·òÆŞ¹ØÏµÈÎÎñË÷Òı
x229024_g_JieBaiMission_IDX		= 132	--½á°İ¹ØÏµÈÎÎñË÷Òı
x229024_g_ShiTuMission_IDX		= 133	--Ê¦Í½¹ØÏµÈÎÎñË÷Òı

--Ìí¼ÓÌØÊâtoÕ ğµ mµt ÖÜÁ¬ĞøÇ§Ñ°,czf,2009.08.07
x229024_g_SpecialBeginTime	= 20090824
x229024_g_SpecialEndTime	= 20090830
--ËùÓµÓĞtoÕ ğµ ÊÂ¼şIDÁĞ±í
x229024_g_EventList	= {}

x229024_g_Impact_Accept_Mission 	= 47	-- Tiªp thøÈÎÎñÊ±toÕ ğµ ÌØĞ§ID
x229024_g_PlayerSlow_LVL					= 10	-- Tiªp thøÈÎÎñtoÕ ğµ ×îµÍµÈc¤p
x229024_g_Activity_DayTime				=	5		-- »î¶¯¼¤»îÊ±¼ä:Ã¿ÖÜÎå

x229024_g_ItemId = { {id=40004435,num=1},
										 {id=40004436,num=1},
										 {id=40004437,num=1},
										 {id=40004438,num=1} }

x229024_g_Impact_Complete_Mission = 43				-- ÈÎÎñÍê³ÉÊ±toÕ ğµ ¼ªÏéÈçÒâÌØĞ§

x229024_g_scenePosInfoList = { {sceneId=7,  scenename="Kiªm Các", PosName="Kiªm môn ği®p thúy", PosX=130, PosY=140,  PosR=10, Area=711 },
															 {sceneId=8,  scenename="Ğôn Hoàng", PosName="Hãn häi c¥u ph§t", PosX=267, PosY=251,  PosR=10, Area=811 },
															 {sceneId=5,  scenename="Kính K°", PosName="Ng÷c ğái lâm phong", PosX=35 , PosY=265,  PosR=10, Area=511 },
															 {sceneId=4,  scenename="Thái H°", PosName="Vû tÕ ca ğài", PosX=155, PosY=255,  PosR=10, Area=411 },
															 {sceneId=3,  scenename="Tung S½n", PosName="Giang s½n ğa ki«u", PosX=280, PosY=80,   PosR=10, Area=311 },
															 {sceneId=30, scenename="Tây H°", PosName="Nh¤t v÷ng h± bào", PosX=170, PosY=230,  PosR=10, Area=3011},
															 {sceneId=31, scenename="Long Tuy«n", PosName="Phi lßu trñc hÕ", PosX=270, PosY=280,  PosR=10, Area=3111},
															 {sceneId=25, scenename="Thß½ng S½n", PosName="Tñ thüy niên hoa", PosX=260, PosY=110,  PosR=10, Area=2512},
															 {sceneId=32, scenename="Võ Di", PosName="Yên töa nh¸ ki«u", PosX=50 , PosY=180,  PosR=10, Area=3211},
															 {sceneId=0,  scenename="LÕc Dß½ng", PosName="Kim thành thang trì", PosX=50,  PosY=220,  PosR=10, Area=11  } }


-- ½±ÀøtoÕ ğµ ÎïÆ·
-- ½ÚÈÕÉñ·û
x229024_g_BonusFuJie = 20310010

-- Ê¥µ®Ã±
x229024_g_BonusItem = { {ItemID01=10410118, ItemID02=10410108},
											  {ItemID01=10410119, ItemID02=10410109},
											  {ItemID01=10410120, ItemID02=10410110},
											  {ItemID01=10410121, ItemID02=10410111},
											  {ItemID01=10410122, ItemID02=10410112},
											  {ItemID01=10410123, ItemID02=10410113},
											  {ItemID01=10410124, ItemID02=10410114},
											  {ItemID01=10410125, ItemID02=10410115},
											  {ItemID01=10410126, ItemID02=10410116},
											  {ItemID01=10410127, ItemID02=10410117} }

x229024_g_BonusEXP_List = { 0,0,0,0,0,0,0,0,0,17436,
														18416,19369,20328,21326,22297,23274,24291,25280,26309,53543,
														55908,58352,60811,63284,65707,68209,70727,73259,75739,126150,
														130300,134474,138564,142784,147029,151297,155479,159795,164133,245746,
														252138,258454,264914,271409,277827,284391,290989,297509,304176,310878,
														317500,324270,331075,337914,344672,351580,358523,365383,372394,379440,
														386403,393517,400666,407731,414948,422200,429367,436688,444043,451433,
														458736,466195,473688,481093,488655,496251,503759,511424,519123,526733,
														534501,542303,550140,557887,565792,573732,581581,589590,597633,605584,
														613696,621842,629895,638110,646360,654515,662834,671187,679574,679574,
														679574,679574,679574,679574,679574,679574,679574,679574,679574,679574,
														679574,679574,679574,679574,679574,679574,679574,679574,679574,        }

--**********************************
--ÈÎÎñÈë¿Úº¯Êı
--**********************************
-- ği¬m»÷¸ÃÈÎÎñºóÖ´ĞĞ´Ë½Å±¾
function x229024_OnDefaultEvent( sceneId, selfId, targetId )

	--ÅĞ¶Ï¸ÃnpcĞúng·ñĞúng¶ÔÓ¦ÈÎÎñtoÕ ğµ npc
	if LuaFnGetName( sceneId, targetId ) ~= x229024_g_Name then
		x229024_NotifyTip( sceneId, selfId, "Nh§n nhi®m vø th¤t bÕi" )
		return 0
	end

	local	key	= GetNumText()
	if key == x229024_g_QianXunMission_IDX then
		BeginEvent(sceneId)
			AddText(sceneId,"#{QX_20071129_023}")
			AddNumText( sceneId, x229024_g_ScriptId, "Phu thê nh§n nhi®m vø", 6, x229024_g_FuQiMission_IDX )
			AddNumText( sceneId, x229024_g_ScriptId, "Kªt bái nh§n nhi®m vø", 6, x229024_g_JieBaiMission_IDX )
			AddNumText( sceneId, x229024_g_ScriptId, "Sß ğ° nh§n nhi®m vø", 6, x229024_g_ShiTuMission_IDX )
		EndEvent(sceneId)
		DispatchEventList(sceneId,selfId,targetId)
	elseif key == x229024_g_MissionInfo_IDX then
		x229024_TalkInfo( sceneId, selfId, targetId, "#{QIANXUN_INFO_02}" )
		return 0

	elseif key == x229024_g_FuQiMission_IDX or key == x229024_g_JieBaiMission_IDX or key == x229024_g_ShiTuMission_IDX then
		if key == x229024_g_FuQiMission_IDX then
			if x229024_CheckMission_FuQi( sceneId, selfId ) == 0 then
				return 0
			end
		elseif key == x229024_g_JieBaiMission_IDX then
			if x229024_CheckMission_JieBai( sceneId, selfId ) == 0 then
				return 0
			end
		elseif key == x229024_g_ShiTuMission_IDX then
			if x229024_CheckMission_ShiTu( sceneId, selfId ) == 0 then
				return 0
			end
		end

		-- Èç¹ûÒÑ¾­½ÓÁËÈÎÎñ
		if IsHaveMission( sceneId, selfId, x229024_g_MissionId ) > 0 then

			--·¢ËÍÈÎÎñĞèÇótoÕ ğµ ĞÅÏ¢
			BeginEvent(sceneId)
				AddText(sceneId, x229024_g_MissionName)
				AddText(sceneId, x229024_g_ContinueInfo)
			EndEvent( )

			local bDone = x229024_CheckSubmit( sceneId, selfId )
			DispatchMissionDemandInfo(sceneId, selfId, targetId, x229024_g_ScriptId, x229024_g_MissionId, bDone)

		else
			-- ÈÎÎñĞúng·ñÒÑÂú
			if IsMissionFull( sceneId, selfId ) == 1 then
				x229024_NotifyTip( sceneId, selfId, "#{QIANXUN_INFO_23}" )
				return 0
			end

			SetMissionData( sceneId, selfId, MD_QIANXUN_SELECT_MISSIONTYPE, key )			-- ÉèÖÃ¶Ó³¤ËùÑ¡toÕ ğµ ÈÎÎñÀàĞÍ

			-- ½øÈëTiªp thøÈÎÎñ½çÃæ
			x229024_AcceptMission( sceneId, selfId, targetId )
		end
	else
		x229024_NotifyTip( sceneId, selfId, "Nh§n nhi®m vø th¤t bÕi" )
		return 0
	end

end

--**********************************
--ÁĞ¾ÙÊÂ¼ş
--**********************************
function x229024_OnEnumerate( sceneId, selfId, targetId )

	--ÅĞ¶Ï¸ÃnpcĞúng·ñĞúng¶ÔÓ¦ÈÎÎñtoÕ ğµ npc
	if LuaFnGetName( sceneId, targetId ) ~= x229024_g_Name then
		return 0
	end

	AddText(sceneId,"#{QIANXUN_INFO_01}")
	if x229024_CheckHuoDongTime() == 1 or x229024_CheckSpecialTime() ==1 then --czf modify
		AddNumText( sceneId, x229024_g_ScriptId, "Thiên T¥m", 6, x229024_g_QianXunMission_IDX )
	end

	AddNumText( sceneId, x229024_g_ScriptId, "Nhi®m vø Thiên T¥m", 11, x229024_g_MissionInfo_IDX )

end

--**********************************
--¼ì²âTiªp thøÌõ¼ş,Ò²¹©×ÓÈÎÎñµ÷ÓÃ
--**********************************
function x229024_CheckAccept( sceneId, selfId, targetId )

	--¼ì²âÍæ¼ÒĞúng·ñ·ûºÏTiªp thøÈÎÎñtoÕ ğµ Ìõ¼ş
	--ÅĞ¶Ï¸ÃnpcĞúng·ñĞúng¶ÔÓ¦ÈÎÎñtoÕ ğµ npc
	if LuaFnGetName( sceneId, targetId ) ~= x229024_g_Name then
		x229024_NotifyTip( sceneId, selfId, "Nh§n nhi®m vø th¤t bÕi" )
		return 0
	end

	--ÒÑ¾­½Ó¹ıÔò²»·ûºÏÌõ¼ş
	if IsHaveMission( sceneId, selfId, x229024_g_MissionId ) > 0 then
		x229024_TalkInfo( sceneId, selfId, targetId, "#{QIANXUN_INFO_19}" )
		return 0
	end

	return 1
end

--**********************************
--Tiªp thø,½ö¹©×ÓÈÎÎñµ÷ÓÃÉèÖÃ¹«¹²²ÎÊı
--**********************************
function x229024_OnAccept( sceneId, selfId, targetId, scriptId )

	--ÅĞ¶Ï¸ÃnpcĞúng·ñĞúng¶ÔÓ¦ÈÎÎñtoÕ ğµ npc
 	if LuaFnGetName( sceneId, targetId ) ~= x229024_g_Name then
 		x229024_NotifyTip( sceneId, selfId, "Nh§n nhi®m vø th¤t bÕi" )
		return 0
	end

	if x229024_CheckAccept( sceneId, selfId, targetId )<=0 then
		return 0
	end

	local	nMisType = GetMissionData( sceneId, selfId, MD_QIANXUN_SELECT_MISSIONTYPE )	--Íæ¼ÒËùÑ¡toÕ ğµ ÈÎÎñÀàĞÍ

	if nMisType == x229024_g_FuQiMission_IDX then
		if x229024_CheckMission_FuQi( sceneId, selfId ) == 0 then
			return 0
		end
	elseif nMisType == x229024_g_JieBaiMission_IDX then
		if x229024_CheckMission_JieBai( sceneId, selfId ) == 0 then
			return 0
		end
	elseif nMisType == x229024_g_ShiTuMission_IDX then
		if x229024_CheckMission_ShiTu( sceneId, selfId ) == 0 then
			return 0
		end
	else
		x229024_NotifyTip( sceneId, selfId, "Nh§n nhi®m vø th¤t bÕi" )
		return 0
	end
	local itemidx = random(getn(x229024_g_ItemId))

	if LuaFnGetTaskItemBagSpace( sceneId, selfId ) < x229024_g_ItemId[itemidx].num then
		x229024_NotifyTip( sceneId, selfId, "#{QX_20071129_027}" )
		return 0
	end

	local nYear	 = LuaFnGetThisYear()
	local nMonth = LuaFnGetThisMonth()
  local nDay   = LuaFnGetDayOfThisMonth()
  local curDayTime = nYear*10000+(nMonth+1)*100+nDay

	BeginAddItem(sceneId)
	AddItem(sceneId,x229024_g_ItemId[itemidx].id, x229024_g_ItemId[itemidx].num)
	local canAdd = EndAddItem(sceneId,selfId)
	if canAdd > 0 then
		--¼ÓÈëÈÎÎñµ½Íæ¼ÒÁĞ±í
		local bAdd = AddMission( sceneId, selfId, x229024_g_MissionId, x229024_g_ScriptId, 0, 1, 0 )
		if bAdd >= 1 then
			AddItemListToHuman(sceneId,selfId)

			-- ği¬mµ½ÈÎÎñtoÕ ğµ ĞòÁĞºÅ
			local	misIndex		= GetMissionIndexByID( sceneId, selfId, x229024_g_MissionId )

			--¸ù¾İĞòÁĞºÅ°ÑÈÎÎñ±äÁ¿toÕ ğµ µÚ0Î»ÖÃ0 (ÈÎÎñÍê³ÉÇé¿ö)
			SetMissionByIndex( sceneId, selfId, misIndex, x229024_g_Mission_IsComplete, 0 )
			--¸ù¾İĞòÁĞºÅ°ÑÈÎÎñ±äÁ¿toÕ ğµ µÚ1Î»ÖÃÎªÈÎÎñ½Å±¾ºÅ
			SetMissionByIndex( sceneId, selfId, misIndex, 2, scriptId )
			SetMissionByIndex(sceneId, selfId, misIndex, x229024_g_Mission_RoundNum, 1)
			SetMissionByIndex(sceneId, selfId, misIndex, x229024_g_Mission_ItemIdx, itemidx)
			SetMissionData( sceneId, selfId, MD_QIANXUN_SELECT_MISSIONTYPE, nMisType )

			if nMisType == x229024_g_FuQiMission_IDX then
				SetMissionData( sceneId, selfId, MD_QIANXUN_FUQI_DAYTIME, curDayTime )
			elseif nMisType == x229024_g_JieBaiMission_IDX then
				SetMissionData( sceneId, selfId, MD_QIANXUN_JIEBAI_DAYTIME, curDayTime )
			elseif nMisType == x229024_g_ShiTuMission_IDX then
				SetMissionData( sceneId, selfId, MD_QIANXUN_SHITU_DAYTIME, curDayTime )
			end

			local ScintInfo = x229024_g_scenePosInfoList[1]
			CallScriptFunction( SCENE_SCRIPT_ID, "AskTheWay", sceneId, selfId, ScintInfo.sceneId, ScintInfo.PosX, ScintInfo.PosY, x229024_g_MissionName)

			BeginEvent(sceneId)
				AddText(sceneId,x229024_g_MissionName)
				AddText(sceneId,x229024_g_MissionInfo)
				AddText(sceneId,"#{M_MUBIAO}#r")
				AddText(sceneId,"#{QX_20071129_025}")
				local strText = format("Nhi®m vø Thiên T¥m vòng 1: TÕi %s t÷a ğµ #{_INFOAIM%d,%d,%d,%s} m¾i có th¬ sØ døng ğÕo cø nhi®m vø.", ScintInfo.scenename, ScintInfo.PosX, ScintInfo.PosY, ScintInfo.sceneId, ScintInfo.scenename)
				AddText(sceneId,strText)
				AddText(sceneId,"#e00f000Nh¡c nhö: Dùng ğÕo cø nhi®m vø ğã nh§n ğßşc ğ¬ xem t÷a ğµ c¥n ğªn.")
			EndEvent( )
			DispatchEventList(sceneId, selfId, targetId)

			-- LuaFnSendSpecificImpactToUnit( sceneId, selfId, selfId, selfId, x229024_g_Impact_Accept_Mission, 0 )
		end
	end

	return 1

end

--**********************************
--·ÅÆú,½ö¹©×ÓÈÎÎñµ÷ÓÃ
--**********************************
function x229024_OnAbandon( sceneId, selfId )

  --É¾³ıÍæ¼ÒÈÎÎñÁĞ±íÖĞ¶ÔÓ¦toÕ ğµ ÈÎÎñ
  local itemidx = 1
  if IsHaveMission( sceneId, selfId, x229024_g_MissionId ) > 0 then
  	local misIndex = GetMissionIndexByID(sceneId,selfId,x229024_g_MissionId)
 	  itemidx = GetMissionParam(sceneId,selfId,misIndex,x229024_g_Mission_ItemIdx)
 	end
	if HaveItem(sceneId, selfId, x229024_g_ItemId[itemidx].id) > 0 then
	  if LuaFnGetAvailableItemCount(sceneId, selfId, x229024_g_ItemId[itemidx].id) >= x229024_g_ItemId[itemidx].num then
	    DelItem( sceneId, selfId, x229024_g_ItemId[itemidx].id, LuaFnGetAvailableItemCount(sceneId, selfId, x229024_g_ItemId[itemidx].id) )
			if IsHaveMission( sceneId, selfId, x229024_g_MissionId ) > 0 then
	 			DelMission( sceneId, selfId, x229024_g_MissionId )
			else
				return 0
			end
	  else
	  	x229024_NotifyTip( sceneId, selfId, "V§t ph¦m cüa các hÕ hi®n không dùng ğßşc ho£c ğã b¸ khóa." )
			return 0
	  end
  else
 		if IsHaveMission( sceneId, selfId, x229024_g_MissionId ) > 0 then
	 		DelMission( sceneId, selfId, x229024_g_MissionId )
		else
			return 0
		end
  end

end

--**********************************
--¼ÌĞø
--**********************************
function x229024_OnContinue( sceneId, selfId, targetId )

	--ÅĞ¶Ï¸ÃnpcĞúng·ñĞúng¶ÔÓ¦ÈÎÎñtoÕ ğµ npc
	if LuaFnGetName( sceneId, targetId ) ~= x229024_g_Name then
		x229024_NotifyTip( sceneId, selfId, "Nh§n nhi®m vø th¤t bÕi" )
		return 0
	end

	--¼ì²âµÈc¤p
	if LuaFnGetLevel( sceneId, selfId ) < x229024_g_PlayerSlow_LVL then
		x229024_NotifyTip( sceneId, selfId, "Nh§n nhi®m vø th¤t bÕi" )
		return 0
	end

	-- ¼ì²éÈÎÎñĞúng·ñÍê³É
	if x229024_CheckSubmit( sceneId, selfId ) ~= 1 then
		return 0
	end

	BeginEvent(sceneId)
		AddText(sceneId,x229024_g_MissionName)
		AddText( sceneId, x229024_g_MissionComplete )
	EndEvent( )
	DispatchMissionContinueInfo(sceneId,selfId,targetId,x229024_g_ScriptId,x229024_g_MissionId)

end

--**********************************
--¼ì²âĞúng·ñ¿ÉÒÔÌá½»
--**********************************
function x229024_CheckSubmit( sceneId, selfId )

	if IsHaveMission( sceneId, selfId, x229024_g_MissionId ) <= 0 then
		return 0
	end

	--TÕi ´ËÅĞ¶ÏÌá½»Ìõ¼şĞúng·ñ·ûºÏ,²¢¸øÓèÏàÓ¦½±Àø
	-- ği¬mµ½ÈÎÎñtoÕ ğµ ĞòÁĞºÅ
	local misIndex = GetMissionIndexByID(sceneId,selfId,x229024_g_MissionId)
	if GetMissionParam(sceneId, selfId, misIndex, 0) > 0 then	--²ì¿´ÈÎÎñĞúng·ñÍê³É
		return 1
	end

	return 0

end

--**********************************
--¼ì²â·òÆŞÈÎÎñ
--**********************************
function x229024_CheckMission_FuQi( sceneId, selfId )

	local nYear	 = LuaFnGetThisYear()
	local nMonth = LuaFnGetThisMonth()
  local nDay   = LuaFnGetDayOfThisMonth()
  local curDayTime = nYear*10000+(nMonth+1)*100+nDay

	local nMisDaytime = 0
	local	IsHaveMis = 0

	--Èç¹ûÍæ¼ÒÒÑ¾­½ÓÁËÈÎÎñ
	if IsHaveMission( sceneId, selfId, x229024_g_MissionId ) > 0 then
		local nMisType 	= GetMissionData( sceneId, selfId, MD_QIANXUN_SELECT_MISSIONTYPE )				-- Íæ¼ÒÉíÉÏtoÕ ğµ ÈÎÎñÀàĞÍ

		if nMisType ~= x229024_g_FuQiMission_IDX then
			x229024_NotifyTip( sceneId, selfId, "#{QIANXUN_INFO_18}" )
			return 0
		end

		IsHaveMis = 1
	else
		nMisDaytime = GetMissionData( sceneId, selfId, MD_QIANXUN_FUQI_DAYTIME )			--  ğÕt ğßşcÉÏ´ÎTiªp thø·òÆŞ¹ØÏµÈÎÎñtoÕ ğµ Ê±¼ä

		if nMisDaytime == curDayTime then
			x229024_NotifyTip( sceneId, selfId, "#{QX_20071129_032}" )

			return 0
		end

		IsHaveMis = 0
	end

	if x229024_GeneralRule( sceneId, selfId ) == 0 then
		return 0
	end

	-- ×é¶ÓÖĞĞúng·ñÓĞÁ½cái(º¬)ÒÔÉÏtoÕ ğµ Ğµi viên
	local NumMem = LuaFnGetTeamSize( sceneId, selfId )
  if NumMem < 2 then
   	if IsHaveMis == 1 then
    	x229024_NotifyTip( sceneId, selfId, "#{QIANXUN_INFO_08}" )
    else
     	x229024_NotifyTip( sceneId, selfId, "#{QIANXUN_INFO_07}" )
    end
    return 0
	end

	-- ×é¶ÓÖĞtoÕ ğµ Á½cáiÈË±ØĞë¶¼TÕi ¸½½ü
	local nNearTeamCount = GetNearTeamCount( sceneId, selfId )
  if GetNearTeamCount( sceneId, selfId ) < 2 then
   	x229024_NotifyTip( sceneId, selfId, "#{QX_20071129_034}" )
    return 0
	end

	--Ğúng·ñÓĞ·òÆŞ¹ØÏµ....
	local ObjID0 = selfId
	local ObjID1
	for i=0, nNearTeamCount-1 do
		ObjID1 = GetNearTeamMember( sceneId, selfId, i )
		if ObjID0 ~= ObjID1 then
			local	SelfGUID	= LuaFnObjId2Guid( sceneId, ObjID0 )
			local	SpouGUID	= LuaFnGetSpouseGUID( sceneId, ObjID1 )

			if LuaFnIsMarried( sceneId, ObjID0 ) ~= 0 and LuaFnIsMarried( sceneId, ObjID1 ) ~= 0 and SelfGUID == SpouGUID then
		    return 1
			end
		end
	end

	x229024_NotifyTip( sceneId, selfId, "#{QIANXUN_INFO_11}" )
	return 0

end

--**********************************
--¼ì²â½á°İÈÎÎñ
--**********************************
function x229024_CheckMission_JieBai( sceneId, selfId )

	local nYear	 = LuaFnGetThisYear()
	local nMonth = LuaFnGetThisMonth()
  local nDay   = LuaFnGetDayOfThisMonth()
  local curDayTime = nYear*10000+(nMonth+1)*100+nDay

	local nMisDaytime = 0
	local	IsHaveMis = 0
	--Èç¹ûÍæ¼ÒÒÑ¾­½ÓÁËÈÎÎñ
	if IsHaveMission( sceneId, selfId, x229024_g_MissionId ) > 0 then
		local nMisType 	= GetMissionData( sceneId, selfId, MD_QIANXUN_SELECT_MISSIONTYPE )				-- Íæ¼ÒÉíÉÏtoÕ ğµ ÈÎÎñÀàĞÍ

		if nMisType ~= x229024_g_JieBaiMission_IDX then
			x229024_NotifyTip( sceneId, selfId, "#{QIANXUN_INFO_18}" )
			return 0
		end

		IsHaveMis = 1
	else
		nMisDaytime = GetMissionData( sceneId, selfId, MD_QIANXUN_JIEBAI_DAYTIME )		--  ğÕt ğßşcÉÏ´ÎTiªp thø½á°İ¹ØÏµÈÎÎñtoÕ ğµ Ê±¼ä

		if nMisDaytime == curDayTime then
			x229024_NotifyTip( sceneId, selfId, "#{QX_20071129_033}" )

			return 0
		end

		IsHaveMis = 0
	end

	if x229024_GeneralRule( sceneId, selfId ) == 0 then
		return 0
	end

	-- ×é¶ÓÖĞĞúng·ñÓĞÁ½cái(º¬)ÒÔÉÏtoÕ ğµ Ğµi viên
	local NumMem = LuaFnGetTeamSize( sceneId, selfId )
  if NumMem < 2 then
   	if IsHaveMis == 1 then
      x229024_NotifyTip( sceneId, selfId, "#{QIANXUN_INFO_15}" )
    else
     x229024_NotifyTip( sceneId, selfId, "#{QIANXUN_INFO_14}" )
    end
    return 0
	end

	-- ×é¶ÓÖĞtoÕ ğµ Ğµi viên ±ØĞë¶¼TÕi ¸½½ü
	local nNearTeamCount = GetNearTeamCount( sceneId, selfId )
  if GetNearTeamCount( sceneId, selfId ) < 2 then
   	x229024_NotifyTip( sceneId, selfId, "#{QX_20071129_035}" )
  	return 0
	end

	--Ğúng·ñÓĞ½á°İ¹ØÏµ....
	local firstPlayer = selfId
	local otherPlayer
	for i=0, nNearTeamCount-1 do
		otherPlayer = GetNearTeamMember( sceneId, selfId, i )
		if firstPlayer ~= otherPlayer then
			if LuaFnIsBrother(sceneId, firstPlayer, otherPlayer) == 1 then
				return 1
			end
		end
	end

	x229024_NotifyTip( sceneId, selfId, "#{QIANXUN_INFO_16}" )
	return 0

end

--**********************************
--¼ì²âÊ¦Í½ÈÎÎñ
--**********************************
function x229024_CheckMission_ShiTu( sceneId, selfId )

	local nYear	 = LuaFnGetThisYear()
	local nMonth = LuaFnGetThisMonth()
  local nDay   = LuaFnGetDayOfThisMonth()
  local curDayTime = nYear*10000+(nMonth+1)*100+nDay

	local nMisDaytime = 0
	local	IsHaveMis = 0
	--Èç¹ûÍæ¼ÒÒÑ¾­½ÓÁËÈÎÎñ
	if IsHaveMission( sceneId, selfId, x229024_g_MissionId ) > 0 then
		local nMisType 	= GetMissionData( sceneId, selfId, MD_QIANXUN_SELECT_MISSIONTYPE )				-- Íæ¼ÒÉíÉÏtoÕ ğµ ÈÎÎñÀàĞÍ

		if nMisType ~= x229024_g_ShiTuMission_IDX then
			x229024_NotifyTip( sceneId, selfId, "#{QIANXUN_INFO_18}" )
			return 0
		end

		IsHaveMis = 1
	else
		nMisDaytime = GetMissionData( sceneId, selfId, MD_QIANXUN_SHITU_DAYTIME )			--  ğÕt ğßşcÉÏ´ÎTiªp thøÊ¦Í½¹ØÏµÈÎÎñtoÕ ğµ Ê±¼ä

		if nMisDaytime == curDayTime then
			x229024_NotifyTip( sceneId, selfId, "#{QX_20071129_039}" )

			return 0
		end

		IsHaveMis = 0
	end

	if x229024_GeneralRule( sceneId, selfId ) == 0 then
		return 0
	end

	-- ×é¶ÓÖĞĞúng·ñÓĞÁ½cái(º¬)ÒÔÉÏtoÕ ğµ Ğµi viên
	local NumMem = LuaFnGetTeamSize( sceneId, selfId )
  if NumMem < 2 then
   	if IsHaveMis == 1 then
       x229024_NotifyTip( sceneId, selfId, "#{QIANXUN_INFO_15}" )
    else
     	x229024_NotifyTip( sceneId, selfId, "#{QIANXUN_INFO_14}" )
    end
    return 0
	end

	-- ×é¶ÓÖĞtoÕ ğµ Ğµi viên ±ØĞë¶¼TÕi ¸½½ü
	local nNearTeamCount = GetNearTeamCount( sceneId, selfId )
  if GetNearTeamCount( sceneId, selfId ) < 2 then
   	x229024_NotifyTip( sceneId, selfId, "#{QIANXUN_INFO_17}" )
    return 0
	end

	-- ¶ÓÎéÖĞĞúng·ñÓĞÊ¦Í½¹ØÏµ....
	local firstPlayer = selfId
	local otherPlayer
	for i=0, nNearTeamCount-1 do
		otherPlayer = GetNearTeamMember( sceneId, selfId, i )
		if firstPlayer ~= otherPlayer then
			if LuaFnIsMaster(sceneId, otherPlayer, firstPlayer) == 1 then
				return 1
			end
			if LuaFnIsMaster(sceneId, firstPlayer, otherPlayer) == 1 then
				return 1
			end
		end
	end

	x229024_NotifyTip( sceneId, selfId, "#{QX_20071129_036}" )
	return 0

end

--**********************************
--Ìá½»,½ö¹©×ÓÈÎÎñµ÷ÓÃ
--**********************************
function x229024_OnSubmit( sceneId, selfId, targetId, selectRadioId )

	--ÅĞ¶Ï¸ÃnpcĞúng·ñĞúng¶ÔÓ¦ÈÎÎñtoÕ ğµ npc
	if LuaFnGetName( sceneId, targetId ) ~= x229024_g_Name then
		x229024_NotifyTip( sceneId, selfId, "Trä nhi®m vø th¤t bÕi" )
		return 0
	end

	--¼ì²âµÈc¤p
	if LuaFnGetLevel( sceneId, selfId ) < x229024_g_PlayerSlow_LVL then
		x229024_NotifyTip( sceneId, selfId, "Trä nhi®m vø th¤t bÕi" )
		return 0
	end

  -- ¼ì²éÈÎÎñĞúng·ñÍê³É
	if x229024_CheckSubmit( sceneId, selfId ) ~= 1 then
		x229024_NotifyTip( sceneId, selfId, "Trä nhi®m vø th¤t bÕi" )
		return 0
	end

	local	nMisType = GetMissionData( sceneId, selfId, MD_QIANXUN_SELECT_MISSIONTYPE )	--Ğµi viên ËùÑ¡toÕ ğµ ÈÎÎñÀàĞÍ

	if nMisType == x229024_g_FuQiMission_IDX then
		if x229024_CheckMission_FuQi( sceneId, selfId ) == 0 then
			return 0
		end
	elseif nMisType == x229024_g_JieBaiMission_IDX then
		if x229024_CheckMission_JieBai( sceneId, selfId ) == 0 then
			return 0
		end
	elseif nMisType == x229024_g_ShiTuMission_IDX then
		if x229024_CheckMission_ShiTu( sceneId, selfId ) == 0 then
			return 0
		end
	else
		x229024_NotifyTip( sceneId, selfId, "Nh§n nhi®m vø th¤t bÕi" )
		return 0
	end

	-- ¶Ó³¤·¢H® th¯ng¹«¸æ
	if selfId == GetTeamLeader( sceneId, selfId ) then
		local temp = ""

		if nMisType == x229024_g_FuQiMission_IDX then
			temp = "#{QX_20071129_043}"
		elseif nMisType == x229024_g_JieBaiMission_IDX then
			temp = "#{QX_20071129_046}"
		elseif nMisType == x229024_g_ShiTuMission_IDX then
			temp = "#{QX_20071129_047}"
		end

		local strText = format("#{_INFOUSR%s}#{QX_20071129_048}%s#{QIANXUN_INFO_24}", GetName(sceneId,selfId), temp )
		BroadMsgByChatPipe( sceneId, 0, strText, 4 )
	end

	local playerlvl = LuaFnGetLevel( sceneId, selfId )
	LuaFnAddExp( sceneId, selfId, x229024_g_BonusEXP_List[playerlvl] )
	DelMission( sceneId, selfId, x229024_g_MissionId )

end

--**********************************
--É±ËÀ¹ÖÎï»òÍæ¼Ò
--**********************************
function x229024_OnKillObject( sceneId, selfId, objdataId ,objId)--²ÎÊıÒâË¼: ³¡¾°ºÅ¡¢Íæ¼ÒobjId¡¢¹ÖÎï±íÎ»ÖÃºÅ¡¢¹ÖÎï
end

--**********************************
--½øÈëÇøÓòÊÂ¼ş
--**********************************
function x229024_OnEnterArea( sceneId, selfId, zoneId )

	if IsHaveMission( sceneId, selfId, x229024_g_MissionId ) <= 0 then
		return 0
	end
	local misIndex = GetMissionIndexByID(sceneId,selfId,x229024_g_MissionId)
	local index = GetMissionParam(sceneId,selfId,misIndex,x229024_g_Mission_RoundNum)
	if sceneId ~= x229024_g_scenePosInfoList[index].sceneId or zoneId ~= x229024_g_scenePosInfoList[index].Area then
		return 0
	end

	local nposX = random(3)
	local nposY = random(3)
	CreateSpecialObjByDataIndex(sceneId, selfId, x229024_g_Impact_Complete_Mission, x229024_g_scenePosInfoList[index].PosX+nposX, x229024_g_scenePosInfoList[index].PosY+nposY, 0)			-- ½øÈëÌ½Ë÷ÇøÓòºó²¥·ÅtoÕ ğµ ÌØĞ§
end

--**********************************
--µÀ¾ß¸Ä±ä
--**********************************
function x229024_OnItemChanged( sceneId, selfId, itemdataId )
end

--**********************************
--½ÓÈÎÎñºóÏÔÊ¾toÕ ğµ ½çÃæ
--**********************************
function x229024_AcceptDialog(sceneId, selfId, rand, g_Dialog, targetId )

	BeginEvent( sceneId )
		AddText( sceneId, g_Dialog )
	EndEvent( sceneId )
	DispatchEventList( sceneId, selfId, targetId )

end

--**********************************
--½»ÈÎÎñºóÏÔÊ¾toÕ ğµ ½çÃæ
--**********************************
function x229024_SubmitDialog( sceneId, selfId, rand )
end

--**********************************
--ĞÑÄ¿ÌáÊ¾
--**********************************
function x229024_NotifyTip( sceneId, selfId, msg )

	BeginEvent( sceneId )
		AddText( sceneId, msg )
	EndEvent( sceneId )
	DispatchMissionTips( sceneId, selfId )

end

--**********************************
--ÓëNPC¶Ô»°
--**********************************
function x229024_TalkInfo( sceneId, selfId, targetId, msg )

	BeginEvent(sceneId)
		AddText( sceneId, msg )
	EndEvent(sceneId)
	DispatchEventList(sceneId,selfId,targetId)

end

--**********************************
--È¡ ği¬m±¾ÊÂ¼ştoÕ ğµ MissionId,ÓÃÓÚobjÎÄ¼şÖĞ¶Ô»°Çé¾°toÕ ğµ ÅĞ¶Ï
--**********************************
function x229024_GetEventMissionId( sceneId, selfId )
	return x229024_g_MissionId
end

function x229024_AcceptMission( sceneId, selfId, targetId )

	--ÅĞ¶Ï¸ÃnpcĞúng·ñĞúng¶ÔÓ¦ÈÎÎñtoÕ ğµ npc
	if LuaFnGetName( sceneId, targetId ) ~= x229024_g_Name then
		x229024_NotifyTip( sceneId, selfId, "Nh§n nhi®m vø th¤t bÕi" )
		return 0
	end

	local  PlayerName=GetName(sceneId,selfId)

	--·¢ËÍÈÎÎñTiªp thøÊ±ÏÔÊ¾toÕ ğµ ĞÅÏ¢
	BeginEvent(sceneId)
		AddText(sceneId,x229024_g_MissionName)
		AddText( sceneId, x229024_g_MissionInfo )
		AddText(sceneId,"#{M_MUBIAO}")
		AddText(sceneId,"#{QX_20071129_025}")
		AddText(sceneId,"#{M_SHOUHUO}")
		AddText(sceneId,"#{QX_20071129_050}")

	EndEvent( )
	DispatchMissionInfo(sceneId,selfId,targetId,x229024_g_ScriptId,x229024_g_MissionId)

end

--/////////////////////////////////////////////////////////////////////////////////////////////////////
--»ñÈ¡¾ßÌåitemtoÕ ğµ ÏêÏ¸ĞÅÏ¢
function x229024_GetItemDetailInfo(itemId)
	local itemId, itemName, itemDesc = GetItemInfoByItemId(itemId)
	if itemId == -1 then
		local strText = format("%sÎïÆ·TÕi 'EquipBase.txt'Ã»ÓĞÕÒµ½!!", itemName)
	end
	return itemId, itemName, itemDesc
end

--/////////////////////////////////////////////////////////////////////////////////////////////////////
-- ¼ì²âÈÎÎñÍ¨ÓÃ¹æÔò
function x229024_GeneralRule( sceneId, selfId )

	if GetLevel( sceneId, selfId ) < x229024_g_PlayerSlow_LVL then
		x229024_NotifyTip( sceneId, selfId, "#{QIANXUN_INFO_10}" )
		return 0
	end

	if x229024_CheckHuoDongTime() ~= 1 and x229024_CheckSpecialTime() ~= 1 then --czf modify
		return 0
	end

	-- ÈÎÎñÎïÆ·À¸Ğúng·ñÒÑÂú
	if LuaFnGetTaskItemBagSpace( sceneId, selfId ) < x229024_g_ItemId[1].num then
		x229024_NotifyTip( sceneId, selfId, "#{QX_20071129_027}" )
		return 0
	end

	-- Ğúng·ñ´¦ÓÚ×é¶Ó×´Ì¬
  if LuaFnHasTeam( sceneId, selfId ) == 0 then
  	--Èç¹ûÍæ¼ÒÒÑ¾­½ÓÁËÈÎÎñ
  	if IsHaveMission( sceneId, selfId, x229024_g_MissionId ) > 0 then
  		x229024_NotifyTip( sceneId, selfId, "#{QIANXUN_INFO_05}" )
  	else
  	  x229024_NotifyTip( sceneId, selfId, "#{QIANXUN_INFO_03}" )
  	end

    return 0
  end

	return 1
end

--*******************************************
--»òÕßĞúng 2009Äê8ÔÂ24ÈÕ0 ği¬mÖÁ2009Äê8ÔÂ30ÈÕ24 ği¬m
--Á¬Ğømµt ÖÜM· ra Ç§Ñ°,czf,2009.08.07
--*******************************************
function x229024_CheckSpecialTime()

	local curDate = GetTime2Day( )

	--Èç¹ûĞúngĞúng 2009Äê8ÔÂ24ÈÕ0 ği¬mÖÁ2009Äê8ÔÂ30ÈÕ24 ği¬mÁ¬Ğømµt ÖÜ,ÔòM· ra
	if curDate >= x229024_g_SpecialBeginTime and curDate <= x229024_g_SpecialEndTime then
		return 1
	else
		return 0
	end

end
--**********************************
--¼ì²â»î¶¯Ê±¼ä
--**********************************
function x229024_CheckHuoDongTime()

  local nDay = GetTodayWeek()

	-- ¼ì²âĞúng·ñĞÇÆÚÎå
  if nDay == x229024_g_Activity_DayTime then
  	return 1
	else
		return 0
	end

end

--**********************************
--µÀ¾ßÊ¹ÓÃ
--**********************************
function x229024_OnUseItem( sceneId, selfId, bagIndex )

	if IsHaveMission( sceneId, selfId, x229024_g_MissionId ) <= 0 then
		return 0
	end

	local misIndex = GetMissionIndexByID(sceneId,selfId,x229024_g_MissionId)
	local nRoundNum = GetMissionParam(sceneId, selfId, misIndex, x229024_g_Mission_RoundNum)
	local ScintInfo = x229024_g_scenePosInfoList[nRoundNum]

	--È¡ ği¬mÍæ¼Òµ±Ç°×ø±ê
	local PlayerX = GetHumanWorldX(sceneId,selfId)
	local PlayerY = GetHumanWorldZ(sceneId,selfId)
	--¼ÆËãÍæ¼ÒÓëÄ¿±ê ği¬mtoÕ ğµ ¾àÀë
	local Distance = floor(sqrt((ScintInfo.PosX-PlayerX)*(ScintInfo.PosX-PlayerX)+(ScintInfo.PosY-PlayerY)*(ScintInfo.PosY-PlayerY)))

	local str = ""

  if nRoundNum >= x229024_g_MaxRound then
  	local missitemid = GetItemTableIndexByIndex( sceneId, selfId, bagIndex )
		local ret = DelItem( sceneId, selfId, missitemid, 1 )

		if ret <= 0 then
			return 0
		end

		-- 100%¼¸ÂÊµôÂä°ü
		-- ¸øHoàn t¤t nhi®m vøtoÕ ğµ Íæ¼Òmµt cáiµôÂä°ü
		local nItemId = 0
		local nItemCount = 0
		local rand =random(100)
		local ntype = 1
		local IsTalkWorld = 0
		local playerlvl = LuaFnGetLevel( sceneId, selfId )

		-- 1/20¼¸ÂÊµôÂäÊ¥µ®Ã±
		-- 31492 ¸ÄÎªµôÂä°ü¼¸ÂÊÎª0
		if random(1) == 10 then
			if playerlvl < 12 then
				ntype = 1
			elseif playerlvl < 22 then
				ntype = 2
			elseif playerlvl < 32 then
				ntype = 3
			elseif playerlvl < 42 then
				ntype = 4
			elseif playerlvl < 52 then
				ntype = 5
			elseif playerlvl < 62 then
				ntype = 6
			elseif playerlvl < 72 then
				ntype = 7
			elseif playerlvl < 82 then
				ntype = 8
			elseif playerlvl < 92 then
				ntype = 9
			else
				ntype = 10
			end

			if rand <= 96 then
				nItemId = x229024_g_BonusItem[ntype].ItemID01					-- Ê°È¡°ó¶¨
				nItemCount = 1
			else
				nItemId = x229024_g_BonusItem[1].ItemID02					-- ×°±¸°ó¶¨
				nItemCount = 1
				IsTalkWorld = 1
			end
		end

		-- local x,z = GetWorldPos(sceneId, selfId)

		-- local nBoxId = DropBoxEnterScene(	x,z,sceneId )

		-- if nBoxId > -1  then
		-- 	AddItemToBox(sceneId,nBoxId,QUALITY_CREATE_BY_BOSS,1,x229024_g_BonusFuJie)
		-- 	if nItemCount > 0 then
		-- 		AddItemToBox(sceneId,nBoxId,QUALITY_CREATE_BY_BOSS,1,nItemId)
		-- 	end
		--
		-- 	-- °ÑCái này µôÂä°ó¶¨¸øÖÆ¶¨Íæ¼Ò
		-- 	SetItemBoxOwner(sceneId, nBoxId, LuaFnGetGUID(sceneId,selfId))
		--
		-- 	if IsTalkWorld == 1 then
		-- 		local strText = format("#{QX_20071129_040}#R#{_INFOUSR%s}#{QX_20071129_041}%s#{QX_20071129_042}", GetName(sceneId,selfId), GetItemName(sceneId,nItemId) )
		-- 		BroadMsgByChatPipe( sceneId, 0, strText, 4 )
		-- 	end
		-- 	-- TÕi ÕâÀï¼ÇÂ¼M· ra ±¦ÏätoÕ ğµ ÈÕÖ¾
		-- 	LuaFnAuditPlayerBehavior(sceneId, selfId, "M· ra Ç§Ñ°±¦Ïä");
		-- end

		SetMissionByIndex( sceneId, selfId, misIndex, x229024_g_Mission_IsComplete, 1 )													-- ÈÎÎñÍê³É

	else

		x229024_NotifyTip( sceneId, selfId, "Tiªn ğ÷: Ğã khám phá "..nRoundNum.."/"..x229024_g_MaxRound )
		nRoundNum = nRoundNum+1
		SetMissionByIndex(sceneId, selfId, misIndex, x229024_g_Mission_RoundNum, nRoundNum)
		ScintInfo = x229024_g_scenePosInfoList[nRoundNum]

		PlayerX = GetHumanWorldX(sceneId,selfId)
		PlayerY = GetHumanWorldZ(sceneId,selfId)
		--¼ÆËãÍæ¼ÒÓëÄ¿±ê ği¬mtoÕ ğµ ¾àÀë
		Distance = floor(sqrt((ScintInfo.PosX-PlayerX)*(ScintInfo.PosX-PlayerX)+(ScintInfo.PosY-PlayerY)*(ScintInfo.PosY-PlayerY)))
		nRoundNum = GetMissionParam(sceneId, selfId, misIndex, x229024_g_Mission_RoundNum)
		CallScriptFunction( SCENE_SCRIPT_ID, "AskTheWay", sceneId, selfId, ScintInfo.sceneId, ScintInfo.PosX, ScintInfo.PosY, x229024_g_MissionName)

		str = format("Vòng thÑ %d: TÕi #G%s#W t÷a ğµ #G%s #{_INFOAIM%d,%d,%d,%s}#W, hãy sØ døng ğÕo cø nhi®m vø ğ¬ hoàn thành.#W.", nRoundNum, ScintInfo.scenename, ScintInfo.PosName, ScintInfo.PosX, ScintInfo.PosY, ScintInfo.sceneId, ScintInfo.scenename)

		BeginEvent(sceneId)
			AddText(sceneId, str)
		EndEvent(sceneId)
		DispatchEventList(sceneId,selfId,-1)
	end
end
